@page "/clients/{id}"
@using System.Text.Json
@using AutoMapper
@using BusinessManagementWebApp.Data
@using BusinessManagementWebApp.Data.Clients.DeleteClient
@using BusinessManagementWebApp.Data.Clients.UpdateClient
@using BusinessManagementWebApp.Data.Entities
@using BusinessManagementWebApp.Infrastructure.Enums

@inject ApiClient api
@inject IMapper mapper
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar

@if (isLoading)
{
    <h1>Fetching Data...</h1>
    <MudSkeleton Width="70%" Height="50px" />
    <MudSkeleton Width="70%" Height="50px" />
    <MudSkeleton Width="70%" Height="50px" />
    <MudSkeleton Width="70%" Height="50px" />
    <MudSkeleton Width="70%" Height="50px" />
    <MudSkeleton Width="70%" Height="50px" />
    <MudSkeleton Width="70%" Height="50px" />
    <MudSkeleton Width="70%" Height="50px" />
    <MudSkeleton Width="70%" Height="50px" />
}
else
{
    <div class="d-flex">
        <div class="mr-auto p-2">
            <h1>@client!.ClientName</h1>
        </div>

        <div class="p-2">
            <MudTooltip Delay="300" Text="Save">
                <MudFab Color="Color.Default"
                        OnClick="OnSave"
                        StartIcon="@Icons.Material.Filled.Save" />
            </MudTooltip>

            <MudTooltip Delay="300" Text="Delete">
                <MudFab Color="Color.Error"
                        OnClick="OnDelete"
                        StartIcon="@Icons.Material.Filled.Delete" />
            </MudTooltip>

            <MudTooltip Delay="300" Text="Cancel">
                <MudFab Color="Color.Error"
                        OnClick="NavigateToClients"
                        StartIcon="@Icons.Material.Filled.Cancel" />
            </MudTooltip>
        </div>
    </div>

    <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6">
        <MudTabPanel Text="Details">
            <MudPaper MaxWidth="70%">
                <MudTextField @bind-Value="client.ClientName" Label="Name" Variant="Variant.Outlined" Required="true" RequiredError="Client Name Required"></MudTextField>
                <MudTextField @bind-Value="client.ClientEmail" Label="Email" Variant="Variant.Outlined"></MudTextField>
                <MudTextField @bind-Value="client.ClientPhone" Label="Phone" Variant="Variant.Outlined"></MudTextField>
                <MudTextField @bind-Value="client.ClientMobile" Label="Mobile" Variant="Variant.Outlined"></MudTextField>
                <MudTextField @bind-Value="client.AddressLine1" Label="Address Line 1" Variant="Variant.Outlined"></MudTextField>
                <MudTextField @bind-Value="client.AddressLine2" Label="Address Line 2" Variant="Variant.Outlined"></MudTextField>
                <MudTextField @bind-Value="client.PostCode" Label="Postcode" Variant="Variant.Outlined"></MudTextField>
                <MudTextField @bind-Value="client.State" Label="State" Variant="Variant.Outlined"></MudTextField>
                <MudTextField @bind-Value="client.Country" Label="Country" Variant="Variant.Outlined"></MudTextField>
            </MudPaper>
        </MudTabPanel>

        <MudTabPanel Text="Transactions">
            <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6">
                <MudTabPanel Text="All">
                    <MudDataGrid Breakpoint="Breakpoint.Sm"
                                 Items="transactions"
                                 Hover="true"
                                 Loading="@isLoading"
                                 LoadingProgressColor="Color.Info"
                                 RowClass="cursor-pointer"
                                 RowClick="TransactionSelected"
                                 T="Transaction">
                        <Columns>
                            <PropertyColumn Property="x => x.TransactionDate" Title="Date" />
                            <PropertyColumn Property="x => x.TransactionRef" Title="Reference" />
                            <PropertyColumn Property="x => x.TransactionType" Title="Type" />
                            <PropertyColumn Property="x => x.NetValue" Title="Net Value" Format="C" />
                        </Columns>
                    </MudDataGrid>
                </MudTabPanel>

                @foreach (var _TransactionType in transactions.Select(t => t.TransactionType).Distinct())
                {
                    <MudTabPanel Text="@(_TransactionType.ToString())">
                        <MudDataGrid Breakpoint="Breakpoint.Sm"
                                     Items="transactions.Where(t => t.TransactionType == _TransactionType)"
                                     Hover="true"
                                     Loading="@isLoading"
                                     LoadingProgressColor="Color.Info"
                                     RowClass="cursor-pointer"
                                     RowClick="TransactionSelected"
                                     T="Transaction">
                            <Columns>
                                <PropertyColumn Property="x => x.TransactionDate" Title="Date" />
                                <PropertyColumn Property="x => x.TransactionRef" Title="Reference" />
                                <PropertyColumn Property="x => x.TransactionType" Title="Type" />
                                <PropertyColumn Property="x => x.NetValue" Title="Net Value" Format="C" />
                            </Columns>
                        </MudDataGrid>
                    </MudTabPanel>
                }
            </MudTabs>
        </MudTabPanel>
    </MudTabs>
}

<MudMessageBox @ref="deleteConfirmationMessage"
               Title="Warning"
               CancelText="Cancel">
    <MessageContent>
        Are you sure you want to delete @(client.ClientName)?
    </MessageContent>
    <YesButton>
        <MudButton Variant="Variant.Filled" Color="Color.Error" StartIcon="@Icons.Material.Filled.DeleteForever">Delete!</MudButton>
    </YesButton>
</MudMessageBox>

@code {

    private Client client = default!;
    private MudMessageBox deleteConfirmationMessage = default!;
    private string deleteState = string.Empty;
    private bool isLoading = true;
    private List<Transaction> transactions = [];

    [Parameter]
    public string id { get; set; } = string.Empty;

    private async Task GetClientData()
    {
        var _Client = await api.GetClientAsync(id);
        var _ClientTransactions = await api.GetClientTransactionsAsync(id);

        client = _Client.Client;
        transactions = _ClientTransactions.Transactions;
    }

    private void NavigateToClients()
        => NavigationManager.NavigateTo("clients");

    private async Task OnDelete()
    {
        bool? result = await deleteConfirmationMessage.ShowAsync();
        deleteState = result is null ? "Canceled" : "Deleted!";

        if (deleteState == "Deleted!")
        {
            var _ClientTransactionCount = await api.GetClientTransactionsAsync(client.ClientID.ToString());
            if (_ClientTransactionCount is null)
            {
                Snackbar.Add($"Error checking {client.ClientName}s Transaction Count.", Severity.Error);
                return;
            }

            if (_ClientTransactionCount.Transactions.Count > 0)
            {
                Snackbar.Add($"{client.ClientName} has Transactions in the system and cannot be deleted.", Severity.Error);
                return;
            }

            var _Request = mapper.Map<DeleteClientRequest>(client);
            var _Response = await api.DeleteClientAsync(_Request);
            if (_Response.IsSuccessStatusCode)
            {
                Snackbar.Add($"{client.ClientName} Deleted.", Severity.Warning);
                NavigateToClients();
            }
            else
                Snackbar.Add($"Error {(int)_Response.StatusCode}: {JsonSerializer.Deserialize<string>(_Response.Content.ReadAsStringAsync().Result)}", Severity.Error);
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await GetClientData();
        isLoading = false;
        this.StateHasChanged();
    }

    private async Task OnSave()
    {
        if (string.IsNullOrEmpty(client!.ClientName))
        {
            Snackbar.Add("Client must have a name.", Severity.Error);
        }
        else
        {
            var _Request = mapper.Map<UpdateClientRequest>(client);
            var _Response = await api.UpdateClientAsync(_Request);

            if (!_Response.IsSuccessStatusCode)
            {
                Snackbar.Add($"Error {(int)_Response.StatusCode}: {JsonSerializer.Deserialize<string>(_Response.Content.ReadAsStringAsync().Result)}", Severity.Error);
                return;
            }

            Snackbar.Add("Client Updated.", Severity.Success);
            NavigationManager.NavigateTo("clients");
        }
    }

    private void TransactionSelected(DataGridRowClickEventArgs<Transaction> args)
    {
        var _SelectedTransaction = args.Item;

        if (_SelectedTransaction is not null && _SelectedTransaction.TransactionType == TransactionType.Invoice.GetCode())
            NavigationManager.NavigateTo($"/transactions/invoices/{_SelectedTransaction.TransactionID}");

        if (_SelectedTransaction is not null && _SelectedTransaction.TransactionType == TransactionType.Receipt.GetCode())
            NavigationManager.NavigateTo($"/transactions/receipts/{_SelectedTransaction.TransactionID}");
    }
}
