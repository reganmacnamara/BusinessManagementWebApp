@page "/clients/{id}"
@using AutoMapper
@using BusinessManagementWebApp.Data
@using BusinessManagementWebApp.Data.Clients.Entities
@using BusinessManagementWebApp.Data.Clients.UpdateClient
@using BusinessManagementWebApp.Data.Transactions.Entities

@inject ApiClient api
@inject IMapper mapper
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar

@if (isLoading)
{
    <h1>Fetching Data...</h1>
    <MudSkeleton Width="70%" Height="50px" />
    <MudSkeleton Width="70%" Height="50px" />
    <MudSkeleton Width="70%" Height="50px" />
    <MudSkeleton Width="70%" Height="50px" />
    <MudSkeleton Width="70%" Height="50px" />
    <MudSkeleton Width="70%" Height="50px" />
    <MudSkeleton Width="70%" Height="50px" />
    <MudSkeleton Width="70%" Height="50px" />
    <MudSkeleton Width="70%" Height="50px" />
}
else
{
    <div class="d-flex">
        <div class="mr-auto p-2">
            <h1>@client!.ClientName</h1>
        </div>

        <div class="p-2">
            <MudTooltip Delay="300" Text="Save">
                <MudFab Color="Color.Default"
                        OnClick="OnSave"
                        StartIcon="@Icons.Material.Filled.Save" />
            </MudTooltip>

            <MudTooltip Delay="300" Text="Cancel">
                <MudFab Color="Color.Error"
                        OnClick="NavigateToClients"
                        StartIcon="@Icons.Material.Filled.Cancel" />
            </MudTooltip>
        </div>
    </div>

    <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6">
        <MudTabPanel Text="Details">
            <MudPaper MaxWidth="70%">
                <MudTextField @bind-Value="client.ClientName" Label="Name" Variant="Variant.Outlined" Required="true" RequiredError="Client Name Required"></MudTextField>
                <MudTextField @bind-Value="client.ClientEmail" Label="Email" Variant="Variant.Outlined"></MudTextField>
                <MudTextField @bind-Value="client.ClientPhone" Label="Phone" Variant="Variant.Outlined"></MudTextField>
                <MudTextField @bind-Value="client.ClientMobile" Label="Mobile" Variant="Variant.Outlined"></MudTextField>
                <MudTextField @bind-Value="client.AddressLine1" Label="Address Line 1" Variant="Variant.Outlined"></MudTextField>
                <MudTextField @bind-Value="client.AddressLine2" Label="Address Line 2" Variant="Variant.Outlined"></MudTextField>
                <MudTextField @bind-Value="client.PostCode" Label="Postcode" Variant="Variant.Outlined"></MudTextField>
                <MudTextField @bind-Value="client.State" Label="State" Variant="Variant.Outlined"></MudTextField>
                <MudTextField @bind-Value="client.Country" Label="Country" Variant="Variant.Outlined"></MudTextField>
            </MudPaper>
        </MudTabPanel>

        <MudTabPanel Text="Transactions">
            <MudDataGrid @bind-SelectedItems="selectedTransactions"
                         Breakpoint="Breakpoint.Sm"
                         Items="transactions"
                         Hover="true"
                         Loading="@isLoading"
                         LoadingProgressColor="Color.Info"
                         MultiSelection="true"
                         RowClass="cursor-pointer"
                         SelectOnRowClick="false"
                         T="Transaction">
                <Columns>
                    <SelectColumn T="Transaction" />
                    <PropertyColumn Property="x => x.TransactionDate" Title="Date" />
                    <PropertyColumn Property="x => x.TransactionRef" Title="Reference" />
                    <PropertyColumn Property="x => x.TransactionType" Title="Type" />
                    <PropertyColumn Property="x => x.Client.ClientName" Title="Client" />
                    <PropertyColumn Property="x => x.NetValue" Title="Net Value" Format="C" />
                </Columns>
            </MudDataGrid>
        </MudTabPanel>
    </MudTabs>
}

@code {

    private Client? client;
    private bool isLoading = true;
    private HashSet<Transaction> selectedTransactions = [];
    private List<Transaction> transactions = [];

    [Parameter]
    public string id { get; set; } = string.Empty;

    private async Task GetClientData()
    {
        var _Client = await api.GetClientAsync(id);
        var _ClientTransactions = await api.GetClientTransactionsAsync(id);

        client = _Client.Client;
        transactions = _ClientTransactions.Transactions;
    }

    private void NavigateToClients()
        => NavigationManager.NavigateTo("clients");

    protected override async Task OnInitializedAsync()
    {
        await GetClientData();
        isLoading = false;
        this.StateHasChanged();
    }

    private async Task OnSave()
    {
        if (string.IsNullOrEmpty(client!.ClientName))
        {
            Snackbar.Add("Client must have a name.", Severity.Error);
        }
        else
        {
            var _Request = mapper.Map<UpdateClientRequest>(client);
            var _Response = await api.UpdateClientAsync(_Request);
            if (_Response.IsSuccessStatusCode)
            {
                Snackbar.Add("Client Updated.", Severity.Success);
                NavigationManager.NavigateTo("clients");
            }
            else
            {
                Snackbar.Add($"Error {(int)_Response.StatusCode}: Client could not be updated.", Severity.Error);
            }

        }
    }
}
