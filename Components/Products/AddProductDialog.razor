@using AutoMapper
@using InvoiceAutomationWebApp.Data
@using InvoiceAutomationWebApp.Data.Products.CreateProduct
@using InvoiceAutomationWebApp.Data.Products.Entities

@inject ApiClient api
@inject IDialogService DialogService
@inject IMapper mapper
@inject ISnackbar Snackbar

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.Edit" Class="mr-3" /> Create Product
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudTextField @bind-Value="product.ProductCode" Label="Code" Variant="Variant.Outlined" Required="true" RequiredError="Product Code Required"></MudTextField>
        <MudTextField @bind-Value="product.ProductName" Label="Name" Variant="Variant.Outlined" Required="true" RequiredError="Product Name Required"></MudTextField>
        <MudTextField @bind-Value="product.ProductDescription" Label="Description" Lines="3" Variant="Variant.Outlined"></MudTextField>
        <MudNumericField @bind-Value="product.UnitCost" Label="Unit Cost" Format="N2" T="decimal" Variant="Variant.Outlined"></MudNumericField>
        <MudNumericField @bind-Value="product.UnitPrice" Label="Unit Price" Format="N2" T="decimal" Variant="Variant.Outlined"></MudNumericField>
        <MudNumericField @bind-Value="product.QuantityOnHand" Label="Quantity on Hand" T="long" Variant="Variant.Outlined"></MudNumericField>
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Filled" Color="Color.Success" OnClick="OnSave" Class="px-10">Create</MudButton>
    </DialogActions>
</MudDialog>

@code {
    private Product product = new()
    {
        ProductCode = string.Empty,
        ProductName = string.Empty
    };
    private int _rating;

    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; }

    private async Task OnSave()
    {
        if (string.IsNullOrEmpty(product.ProductCode))
        {
            Snackbar.Add("Product must have a Code.", Severity.Error);
            return;
        }

        if (string.IsNullOrEmpty(product.ProductName))
        {
            Snackbar.Add("Product must have a Name.", Severity.Error);
            return;
        }

        var _Request = mapper.Map<CreateProductRequest>(product);
        var _Response = await api.CreateProductAsync(_Request);
        if (_Response.IsSuccessStatusCode)
        {
            Snackbar.Add("Product Created.", Severity.Success);
            MudDialog.Close(DialogResult.Ok(true));
        }
        else
        {
            Snackbar.Add($"Error {(int)_Response.StatusCode}: Product could not be created.", Severity.Error);
        }
    }
}
