@page "/transactions/create"
@using AutoMapper
@using BusinessManagementWebApp.Components.Clients
@using BusinessManagementWebApp.Data
@using BusinessManagementWebApp.Data.Clients.Entities
@using BusinessManagementWebApp.Data.Transactions.CreateTransaction
@using BusinessManagementWebApp.Data.Transactions.Entities
@using BusinessManagementWebApp.Infrastructure.Enums

@inject ApiClient api
@inject IMapper mapper
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager

<div class="d-flex">
    <div class="mr-auto p-2">
        <h1>New Transaction</h1>
    </div>

    <div class="p-2">
        <MudTooltip Delay="300"
                    Text="Save">

            <MudFab Color="Color.Default"
                    OnClick="OnSave"
                    StartIcon="@Icons.Material.Filled.Save" />

        </MudTooltip>

        <MudTooltip Delay="300"
                    Text="Cancel">

            <MudFab Color="Color.Error"
                    OnClick="NavigateToTransactions"
                    StartIcon="@Icons.Material.Filled.Cancel" />

        </MudTooltip>
    </div>
</div>

<MudPaper MaxWidth="30%">
    <MudTextField @bind-Value="transaction.TransactionRef" Label="Transaction Reference" Variant="Variant.Outlined" Required="true" RequiredError="Transaction Reference Required" />
    <MudDatePicker @bind-Date="transaction.TransactionDate" Label="Transaction Date" />
    <MudSelect @bind-Value="transaction.TransactionType" Label="Transaction Type" Placeholder="Please Select">
        <MudSelectItem Value="TransactionType.Invoice.GetCode()">Invoice</MudSelectItem>
        <MudSelectItem Value="TransactionType.Receipt.GetCode()">Receipt</MudSelectItem>
    </MudSelect>
    <MudDatePicker @bind-Date="transaction.DueDate" Label="Transaction Due Date" Disabled="IsReciept()" />
    <div class="d-flex flex-row">
        <MudSelect @key="clients.Count" Value="transaction.Client" T="Client" Label="Client" Placeholder="Select Client" ValueChanged="OnClientChanged">
            @foreach (var client in clients)
            {
                <MudSelectItem Value="client">@client.ClientName</MudSelectItem>
            }
        </MudSelect>
        <MudFab Color="Color.Success"
                IconSize="Size.Small"
                OnClick="OpenCreateClientDialogAsync"
                Size="Size.Small"
                StartIcon="@Icons.Material.Filled.Add" />
    </div>
</MudPaper>

<AddClientDialog />

<AddTransactionItemDialog />

@code {
    private List<Client> clients = [];
    private Transaction transaction = new();

    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; }

    private async Task GetClients()
    {
        var _Response = await api.GetClientsAsync();

        clients = _Response.Clients ?? [];
        this.StateHasChanged();
    }

    private bool IsReciept()
        => transaction.TransactionType == TransactionType.Receipt.GetCode();

    private void NavigateToTransactions()
        => NavigationManager.NavigateTo("transactions");

    protected override async Task OnInitializedAsync()
        => await GetClients();

    private async Task OnSave()
    {
        if (string.IsNullOrEmpty(transaction.TransactionRef))
        {
            Snackbar.Add("Transaction must have a reference.", Severity.Error);
            return;
        }

        if (transaction.Client is null)
        {
            Snackbar.Add("Transaction must have a client.", Severity.Error);
            return;
        }

        var _Request = mapper.Map<CreateTransactionRequest>(transaction);
        var _Response = await api.CreateTransactionAsync(_Request);

        if (!_Response.IsSuccessStatusCode)
            Snackbar.Add($"Error {(int)_Response.StatusCode}: Transaction could not be created.", Severity.Error);

        Snackbar.Add("Transaction Created.", Severity.Success);
    }

    private async Task OpenCreateClientDialogAsync()
    {
        var dialog = await DialogService.ShowAsync<AddClientDialog>();

        var result = await dialog.Result;

        if (dialog.Result is not null && !dialog.Result.IsCanceled && result is not null && result.Data is not null)
        {
            SelectCreatedClient((Client)result.Data);
            await GetClients();
            StateHasChanged();
        }
    }

    private async Task OnClientChanged(Client client)
    {
        transaction.Client = client;
        transaction.ClientID = client.ClientID;
    }

    private void SelectCreatedClient(Client client)
    {
        clients.Add(client);
        transaction.Client = client;
        transaction.ClientID = client.ClientID;
        StateHasChanged();
    }
}